{"version":3,"sources":["../src/startAttempt.js"],"names":["define","$","Ajax","Notification","setup","props","window","share_state","document","getElementById","window_surface","screenoff","videoElem","logElem","displayMediaOptions","video","cursor","audio","click","event","preventDefault","startCapture","css","photo","canvas","context","getContext","drawImage","width","height","data","toDataURL","setAttribute","courseid","value","cmid","profileimage","style","display","call","methodname","args","done","warnings","length","status","addNotification","message","type","fail","exception","innerHTML","navigator","mediaDevices","getDisplayMedia","srcObject","dumpOptionsInfo","errString","toString","alert","screenShotInterval","setInterval","takeScreenshot","videoTrack","getVideoTracks","currentStream","active","settings","getSettings","displaySurface","clearInterval","close","video_screen","canvas_screen","screen_context","screen","screen_data","params","id","screenshotinterval","windowState","updateWindowStatus","stop","location","reload"],"mappings":"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","sourcesContent":["define(['jquery', 'core/ajax', 'core/notification'],\n    function($, Ajax, Notification) {\n        return {\n            setup: function(props) {\n                // Console.log('start attempt loaded');\n                // console.log(props);\n\n                window.share_state = document.getElementById('share_state');\n                window.window_surface = document.getElementById('window_surface');\n                window.screenoff = document.getElementById('screen_off_flag');\n\n                const videoElem = document.getElementById(\"video-screen\");\n                const logElem = document.getElementById(\"log-screen\");\n                var displayMediaOptions = {\n                    video: {\n                        cursor: \"always\"\n                    },\n                    audio: false\n                };\n\n                $(\"#share_screen_btn\").click(function() {\n                    event.preventDefault();\n                    // Console.log('screen sharing clicked');\n                    startCapture();\n                    $(\"#form_activate\").css(\"visibility\", \"visible\");\n                    // Options for getDisplayMedia()\n\n                });\n\n                $(\"#fcvalidate\").click(function() {\n                    event.preventDefault();\n                    // Console.log('validate face clicked');\n                    var photo = document.getElementById('photo');\n                    var canvas = document.getElementById('canvas');\n                    var video = document.getElementById('video');\n                    var context = canvas.getContext('2d');\n                    context.drawImage(video, 0, 0, canvas.width, canvas.height);\n                    var data = canvas.toDataURL('image/png');\n                    photo.setAttribute('src', data);\n\n                    var courseid = document.getElementById('courseidval').value;\n                    var cmid = document.getElementById('cmidval').value;\n                    var profileimage = document.getElementById('profileimage').value;\n\n                    var wsfunction = 'quizaccess_proctoring_validate_face';\n                    var params = {\n                        'courseid': courseid,\n                        'cmid': cmid,\n                        'profileimage': profileimage,\n                        'webcampicture': data,\n                    };\n\n                    var request = {\n                        methodname: wsfunction,\n                        args: params\n                    };\n                    document.getElementById('loading_spinner').style.display = 'block';\n                    Ajax.call([request])[0].done(function(data) {\n                        if (data.warnings.length < 1) {\n                            document.getElementById('loading_spinner').style.display = 'none';\n                            // NO; pictureCounter++;\n                            // console.log('api response', data);\n                            var status = data.status;\n                            if (status == 'success') {\n                                $(\"#video\").css(\"border\", \"10px solid green\");\n                                // Document.getElementById(\"validate_form\").style.display = \"none\";\n                                document.getElementById(\"fcvalidate\").style.display = \"none\";\n                                document.getElementById(\"share_screen_btn\").style.display = \"block\";\n                            } else {\n                                $(\"#video\").css(\"border\", \"10px solid red\");\n                            }\n                        } else {\n                            document.getElementById('loading_spinner').style.display = 'none';\n                            if (video) {\n                                Notification.addNotification({\n                                    message: 'Something went wrong during taking the image.',\n                                    type: 'error'\n                                });\n                            }\n                        }\n                    }).fail(Notification.exception);\n\n                });\n\n\n                async function startCapture() {\n                    logElem.innerHTML = \"\";\n                    try {\n                        // Console.log(\"vid found success\");\n                        videoElem.srcObject = await navigator.mediaDevices.getDisplayMedia(displayMediaOptions);\n                        dumpOptionsInfo();\n                    } catch (err) {\n                        // Console.log(\"Error: \" + err.toString());\n                        let errString = err.toString();\n                        if (errString == \"NotAllowedError: Permission denied\") {\n                            alert(\"Please share entire screen.\");\n                            return false;\n                        }\n                    }\n                }\n\n                function dumpOptionsInfo() {\n                    // Const videoTrack = videoElem.srcObject.getVideoTracks()[0];\n\n                    // Console.info(\"Track settings:\");\n                    // console.info(JSON.stringify(videoTrack.getSettings(), null, 2));\n                    // console.info(\"Track constraints:\");\n                    // console.info(JSON.stringify(videoTrack.getConstraints(), null, 2));\n                }\n\n                var updateWindowStatus = function() {\n                    if (videoElem.srcObject !== null) {\n                        // Console.log(videoElem);\n                        const videoTrack = videoElem.srcObject.getVideoTracks()[0];\n                        var currentStream = videoElem.srcObject;\n                        var active = currentStream.active;\n                        var settings = videoTrack.getSettings();\n                        var displaySurface = settings.displaySurface;\n                        document.getElementById('window_surface').value = displaySurface;\n                        document.getElementById('share_state').value = active;\n                        var screenoff = document.getElementById('screen_off_flag').value;\n                        if (screenoff == \"1\") {\n                            videoTrack.stop();\n                            // Console.log('video stopped');\n                            clearInterval(windowState);\n                            location.reload();\n                        }\n                    }\n                };\n\n                var takeScreenshot = function() {\n                    var screenoff = document.getElementById('screen_off_flag').value;\n                    if (videoElem.srcObject !== null) {\n                        // Console.log(videoElem);\n                        const videoTrack = videoElem.srcObject.getVideoTracks()[0];\n                        var currentStream = videoElem.srcObject;\n                        var active = currentStream.active;\n                        // Console.log(active);\n\n                        var settings = videoTrack.getSettings();\n                        var displaySurface = settings.displaySurface;\n\n                        if (screenoff == \"0\") {\n                            if (!active) {\n                                alert(\"Sorry !! You need to restart the attempt as you have stopped the screenshare.\");\n                                clearInterval(screenShotInterval);\n                                window.close();\n                                return false;\n                            }\n\n                            if (displaySurface !== \"monitor\") {\n                                alert(\"Sorry !! You need to share entire screen.\");\n                                clearInterval(screenShotInterval);\n                                window.close();\n                                return false;\n                            }\n\n                        }\n                        // Console.log(displaySurface);\n                        // console.log(quizurl);\n\n                        // Capture Screen\n                        var video_screen = document.getElementById('video-screen');\n                        var canvas_screen = document.getElementById('canvas-screen');\n                        var screen_context = canvas_screen.getContext('2d');\n                        // Var photo_screen = document.getElementById('photo_screen');\n                        canvas_screen.width = screen.width;\n                        canvas_screen.height = screen.height;\n                        screen_context.drawImage(video_screen, 0, 0, screen.width, screen.height);\n                        var screen_data = canvas_screen.toDataURL('image/png');\n                        // Photo_screen.setAttribute('src', screen_data);\n                        // console.log(screen_data);\n\n                        // API Call\n                        var wsfunction = 'quizaccess_proctoring_send_camshot';\n                        var params = {\n                            'courseid': props.courseid,\n                            'screenshotid': props.id,\n                            'quizid': props.cmid,\n                            'webcampicture': screen_data,\n                            'imagetype': 2\n                        };\n\n                        var request = {\n                            methodname: wsfunction,\n                            args: params\n                        };\n\n                        // Console.log('params', params);\n                        if (screenoff == \"0\") {\n                            Ajax.call([request])[0].done(function(data) {\n                                if (data.warnings.length < 1) {\n                                    // NO; pictureCounter++;\n                                } else {\n                                    if (video_screen) {\n                                        Notification.addNotification({\n                                            message: 'Something went wrong during taking the image.',\n                                            type: 'error'\n                                        });\n                                        clearInterval(screenShotInterval);\n                                    }\n                                }\n                            }).fail(Notification.exception);\n                        }\n                    }\n                };\n                var screenShotInterval = setInterval(takeScreenshot, props.screenshotinterval);\n                var windowState = setInterval(updateWindowStatus, 1000);\n                return true;\n            }\n        };\n    });\n"],"file":"startAttempt.min.js"}